<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendBot Dashboard</title>
    <!-- Tailwind via CDN for simplicity -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .neon-text {
            text-shadow: 0 0 10px rgba(52, 211, 153, 0.5);
        }

        /* Custom overrides if needed */
        .token-row:hover .sold-input {
            background-color: #374151;
        }
    </style>
    <script>
        const START_BALANCE = 1000;
        const BET_SIZE = 100;

        function calculatePortfolio() {
            let realizedPnL = 0;
            let wins = 0;
            let losses = 0;
            let totalClosed = 0;

            document.querySelectorAll('.token-row').forEach(row => {
                const foundMc = parseFloat(row.dataset.foundMc);
                const soldInput = row.querySelector('.sold-input');
                const pnlCell = row.querySelector('.pnl-cell');
                const soldMcVal = soldInput.value;

                if (soldMcVal && !isNaN(soldMcVal)) {
                    // User inputs 'k' value (e.g. 500 for 500k), convert to full
                    const soldMc = parseFloat(soldMcVal) * 1000;
                    // PnL Formula: (Sold / Found) * Bet - Bet
                    const pnl = (soldMc / foundMc * BET_SIZE) - BET_SIZE;

                    realizedPnL += pnl;
                    totalClosed++;

                    if (pnl > 0) wins++;
                    else losses++;

                    // Update PnL Cell
                    pnlCell.textContent = `$${pnl.toFixed(2)}`;
                    pnlCell.className = `pnl-cell font-bold ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
                } else {
                    pnlCell.textContent = '-';
                    pnlCell.className = 'pnl-cell text-gray-500';
                }
            });

            // Update Cards
            const currentBalance = START_BALANCE + realizedPnL;
            const growth = ((currentBalance - START_BALANCE) / START_BALANCE) * 100;

            document.getElementById('portfolio-value').textContent = `$${currentBalance.toFixed(2)}`;
            document.getElementById('total-pnl').textContent = `${realizedPnL >= 0 ? '+' : ''}$${realizedPnL.toFixed(2)}`;
            document.getElementById('total-pnl').className = `text-4xl font-bold ${realizedPnL >= 0 ? 'text-green-400' : 'text-red-400'}`;

            document.getElementById('growth-pct').textContent = `${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%`;
            document.getElementById('growth-pct').className = `text-4xl font-bold ${growth >= 0 ? 'text-green-400' : 'text-red-400'}`;

            // Safe division check
            const winRate = totalClosed > 0 ? (wins / totalClosed) * 100 : 0;
            document.getElementById('win-rate-display').textContent = `${winRate.toFixed(0)}%`;

            // Update Total Count
            const totalRows = document.querySelectorAll('.token-row').length;
            document.getElementById('trade-count').textContent = `${totalRows} Trades`;
        }

        async function saveSoldMc(mint, input) {
            const val = input.value;
            if (!val) return;

            // Save as full value (x1000)
            const soldMc = parseFloat(val) * 1000;

            // Optimistic update
            calculatePortfolio();

            try {
                await fetch(`/api/tokens/${mint}/sold-mc`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ soldMc })
                });

                // Visual feedback
                input.classList.add('border-green-500');
                setTimeout(() => input.classList.remove('border-green-500'), 1000);
            } catch (err) {
                console.error(err);
                alert('Save failed');
            }
        }

        async function markRug(mint) {
            const row = document.querySelector(`tr[data-mint="${mint}"]`);
            const input = row.querySelector('.sold-input');
            input.value = 0;
            await saveSoldMc(mint, input);
            window.location.reload(); // Refresh to update button state
        }

        async function unRug(mint) {
            const row = document.querySelector(`tr[data-mint="${mint}"]`);
            const input = row.querySelector('.sold-input');

            // 1. Clear input (or set to empty so user can type)
            input.value = '';

            // 2. Set status to TRACKING via API
            try {
                await fetch(`/api/tokens/${mint}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'TRACKING' })
                });
                window.location.reload(); // Refresh to switch button back
            } catch (err) {
                console.error(err);
                alert('Unrug failed');
            }
        }

        async function resetDb() {
            if (!confirm('üß® DANGER: This will wipe ALL data (Tokens, Performance, Alerts). Are you sure?')) return;

            try {
                const res = await fetch('/api/admin/reset-db', { method: 'POST' });
                const json = await res.json();
                if (json.success) {
                    alert('Database Reset Successful');
                    window.location.reload();
                } else {
                    alert('Reset Failed');
                }
            } catch (err) {
                console.error(err);
                alert('Reset Request Failed');
            }
        }

        async function deleteToken(mint) {
            if (!confirm('üóëÔ∏è Delete this token permanently?')) return;
            try {
                const res = await fetch(`/api/tokens/${mint}`, { method: 'DELETE' });
                const json = await res.json();
                if (json.success) {
                    // Remove row instantly
                    const row = document.querySelector(`tr[data-mint="${mint}"]`);
                    if (row) row.remove();
                    calculatePortfolio(); // Recalculate stats
                } else {
                    alert('Delete Failed');
                }
            } catch (err) {
                console.error(err);
                alert('Delete Request Failed');
            }
        }

        function copyToClipboard(text, btnElement) {
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                const originalText = btnElement.innerHTML;
                btnElement.innerHTML = '<span class="text-green-400">Copied!</span>';
                setTimeout(() => {
                    btnElement.innerHTML = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        // Init
        document.addEventListener('DOMContentLoaded', calculatePortfolio);
    </script>
</head>

<body class="bg-gray-900 text-gray-100 font-sans">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8 flex justify-between items-center border-b border-gray-700 pb-4">
            <div>
                <h1
                    class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-blue-500 neon-text">
                    TrendBot PnL Tracker
                </h1>
                <p class="text-gray-400 text-sm mt-1">Simulated Portfolio: $1000 Start | $100 Bets</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500">Last Updated</div>
                <div class="font-mono text-green-400">
                    <%= lastUpdated.toLocaleTimeString() %>
                </div>
                <button onclick="resetDb()"
                    class="mt-2 text-xs bg-red-900/50 hover:bg-red-800 text-red-300 font-bold py-1 px-2 rounded border border-red-800 transition-colors">
                    üí£ RESET DB
                </button>
            </div>
        </header>

        <!-- Metrics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Portfolio Value -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                <div class="text-gray-400 text-sm font-semibold uppercase tracking-wider">Portfolio Value</div>
                <div class="mt-2 text-4xl font-bold text-white" id="portfolio-value">
                    $1000.00
                </div>
            </div>

            <!-- Total PnL -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                <div class="text-gray-400 text-sm font-semibold uppercase tracking-wider">Total PnL</div>
                <div class="mt-2 text-4xl font-bold text-gray-400" id="total-pnl">
                    $0.00
                </div>
            </div>

            <!-- Growth -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                <div class="text-gray-400 text-sm font-semibold uppercase tracking-wider">Growth (Win Rate: <span
                        id="win-rate-display">0%</span>)</div>
                <div class="mt-2 text-4xl font-bold text-gray-400" id="growth-pct">
                    0.0%
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex space-x-4 mb-6">
            <button onclick="switchTab('live')" id="tab-live"
                class="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-500 transition-colors">
                üî¥ Live Trades
            </button>
            <button onclick="switchTab('performance')" id="tab-performance"
                class="px-4 py-2 bg-gray-700 text-gray-400 rounded font-bold hover:bg-gray-600 hover:text-white transition-colors">
                üß¨ Bot Performance (Autopsy)
            </button>
        </div>

        <!-- VIEW: LIVE TRADES -->
        <div id="view-live">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                <span class="mr-2">üìù</span> Trade Log <span id="trade-count"
                    class="ml-3 text-sm text-gray-400 font-normal border border-gray-700 px-2 py-0.5 rounded-full">0
                    Trades</span>
            </h2>
            <div class="bg-gray-800 rounded-xl overflow-hidden shadow-lg border border-gray-700">
                <table class="w-full text-left">
                    <thead class="bg-gray-700 text-gray-300">
                        <tr>
                            <th class="px-6 py-3 w-1/4">Token</th>
                            <th class="px-6 py-3">Found MC</th>
                            <th class="px-6 py-3">Sold MC</th>
                            <th class="px-6 py-3">PnL</th>
                            <th class="px-6 py-3 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        <% metrics.recentCalls.forEach(token=> {
                            const baseMc = token.foundMc > 0 ? token.foundMc : token.alertMc;
                            %>
                            <tr class="hover:bg-gray-750 transition-colors token-row" data-mint="<%= token.mint %>"
                                data-found-mc="<%= baseMc %>">

                                <!-- TOKEN COLUMN -->
                                <td class="px-6 py-4">
                                    <div class="flex flex-col">
                                        <span class="font-bold text-white text-lg">
                                            <%= token.symbol %>
                                        </span>
                                        <button onclick="copyToClipboard('<%= token.mint %>', this)"
                                            class="text-xs text-gray-500 font-mono text-left hover:text-white transition-colors focus:outline-none">
                                            <%= token.mint.substring(0,6) %>... üìã
                                        </button>
                                        <div class="mt-1 flex items-center">
                                            <span class="text-xs text-gray-400">
                                                <%= new Date(token.alertTimestamp).toLocaleTimeString() %>
                                            </span>
                                            <% const isEVM=token.mint.startsWith('0x'); const chain=isEVM ? 'base'
                                                : 'solana' ; %>
                                                <a href="https://dexscreener.com/<%= chain %>/<%= token.mint %>"
                                                    target="_blank" rel="noopener noreferrer"
                                                    class="ml-2 text-blue-400 hover:text-blue-300 text-xs font-semibold z-10 relative pointer-events-auto">
                                                    Chart ‚Üó
                                                </a>
                                        </div>
                                    </div>
                                </td>

                                <!-- FOUND MC -->
                                <td class="px-6 py-4 text-gray-300 font-mono">
                                    $<%= (baseMc / 1000).toFixed(1) %>k
                                </td>

                                <!-- SOLD MC (Input) -->
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <span class="text-gray-500 mr-1">$</span>
                                        <input type="number" step="any"
                                            class="sold-input bg-gray-900 border border-gray-600 rounded px-2 py-1 w-24 text-white focus:border-blue-500 outline-none transition-colors"
                                            placeholder="Open"
                                            value="<%= token.status === 'RUGGED' ? '0' : (token.soldMc > 0 ? (token.soldMc / 1000).toFixed(1) : '') %>"
                                            onchange="saveSoldMc('<%= token.mint %>', this)">
                                        <span class="text-gray-500 ml-1">k</span>
                                    </div>
                                </td>

                                <!-- PNL (Calculated) -->
                                <td class="px-6 py-4 pnl-cell font-mono text-gray-500">
                                    -
                                </td>

                                <!-- ACTION -->
                                <td class="px-6 py-4 text-right">
                                    <% if (token.status==='RUGGED' ) { %>
                                        <button onclick="unRug('<%= token.mint %>')"
                                            class="bg-green-900 hover:bg-green-800 text-green-200 text-xs font-bold py-1 px-3 rounded transition-colors border border-green-800">
                                            üöë UNRUG
                                        </button>
                                        <% } else { %>
                                            <button onclick="markRug('<%= token.mint %>')"
                                                class="bg-red-900 hover:bg-red-800 text-red-200 text-xs font-bold py-1 px-3 rounded transition-colors border border-red-800">
                                                üíÄ RUG
                                            </button>
                                            <button onclick="deleteToken('<%= token.mint %>')"
                                                class="ml-2 text-xs text-red-900 hover:text-red-500 transition-colors"
                                                title="Delete">
                                                üóëÔ∏è
                                            </button>
                                            <% } %>
                                </td>
                            </tr>
                            <% }); %>
                                <% if(metrics.recentCalls.length===0) { %>
                                    <tr>
                                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">No trades yet.</td>
                                    </tr>
                                    <% } %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: PERFORMANCE REPORT -->
        <div id="view-performance" class="hidden">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                <span class="mr-2">üèÜ</span> Autopsy Report (True ATH)
            </h2>

            <!-- SIMULATION CARDS -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <div class="text-gray-400 text-xs font-bold uppercase">Total Plays</div>
                    <div class="text-3xl font-bold text-white mt-1" id="sim-count">0</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <div class="text-gray-400 text-xs font-bold uppercase">Investment ($100/ea)</div>
                    <div class="text-3xl font-bold text-blue-400 mt-1" id="sim-invested">$0</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <div class="text-gray-400 text-xs font-bold uppercase">Portfolio Value (At Peak)</div>
                    <div class="text-3xl font-bold text-green-400 mt-1" id="sim-value">$0</div>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <div class="text-gray-400 text-xs font-bold uppercase">Net Profit</div>
                    <div class="text-3xl font-bold text-gray-500 mt-1" id="sim-pnl">$0</div>
                </div>
            </div>

            <!-- STRATEGY LAB -->
            <div class="bg-gray-800 rounded-xl p-6 border border-blue-900/50 mb-8 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl">üß™</div>
                <h3 class="text-2xl font-bold text-white mb-2 relative z-10">üß™ Strategy Lab: "The 1.5x / 2.5x Split"
                </h3>
                <p class="text-gray-400 text-sm mb-6 relative z-10 max-w-2xl">
                    Simulation based on $100 entry per token.<br>
                    ‚Ä¢ <b>TP1:</b> Sell 50% @ 1.5x <br>
                    ‚Ä¢ <b>TP2:</b> Sell 50% @ 2.5x <br>
                    ‚Ä¢ <b>Rule:</b> If TP1 hit, Stop Loss moves to Entry (Break Even). If TP1 missed, assume 100% Loss.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 relative z-10">
                    <!-- Strategy PnL -->
                    <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Strategy Net Profit</div>
                        <div class="text-3xl font-bold mt-1" id="strat-pnl">Calculating...</div>
                        <div class="text-xs text-gray-400 mt-1" id="strat-roi">ROI: 0%</div>
                    </div>

                    <!-- Hit Rate (1.5x) -->
                    <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">TP1 Hit Rate (1.5x)</div>
                        <div class="text-3xl font-bold text-blue-400 mt-1" id="strat-tp1">0%</div>
                        <div class="text-xs text-gray-400 mt-1" id="strat-tp1-count">0 Tokens</div>
                    </div>

                    <!-- Full Win Rate (2.5x) -->
                    <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Full Win Rate (2.5x)</div>
                        <div class="text-3xl font-bold text-green-400 mt-1" id="strat-tp2">0%</div>
                        <div class="text-xs text-gray-400 mt-1" id="strat-tp2-count">0 Tokens</div>
                    </div>

                    <!-- Rekt Rate -->
                    <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                        <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Loss Rate (<1.5x)< /div>
                                <div class="text-3xl font-bold text-red-400 mt-1" id="strat-rekt">0%</div>
                                <div class="text-xs text-gray-400 mt-1 text-red-900" id="strat-loss-val">-$0</div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl overflow-hidden shadow-lg border border-gray-700">
                    <table class="w-full text-left" id="perf-table">
                        <thead class="bg-gray-700 text-gray-300">
                            <tr>
                                <th class="px-6 py-3">Rank</th>
                                <th class="px-6 py-3">Token</th>
                                <th class="px-6 py-3">Entry MC</th>
                                <th class="px-6 py-3">True ATH</th>
                                <th class="px-6 py-3">Peak Value ($100 bet)</th>
                                <th class="px-6 py-3">Multiplier</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700" id="perf-body">
                            <!-- Populated via JS -->
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading Report...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <script>
                let reportLoaded = false;

                function switchTab(tab) {
                    const liveBtn = document.getElementById('tab-live');
                    const perfBtn = document.getElementById('tab-performance');
                    const liveView = document.getElementById('view-live');
                    const perfView = document.getElementById('view-performance');

                    if (tab === 'live') {
                        liveView.classList.remove('hidden');
                        perfView.classList.add('hidden');
                        liveBtn.className = "px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-500 transition-colors";
                        perfBtn.className = "px-4 py-2 bg-gray-700 text-gray-400 rounded font-bold hover:bg-gray-600 hover:text-white transition-colors";
                    } else {
                        liveView.classList.add('hidden');
                        perfView.classList.remove('hidden');
                        liveBtn.className = "px-4 py-2 bg-gray-700 text-gray-400 rounded font-bold hover:bg-gray-600 hover:text-white transition-colors";
                        perfBtn.className = "px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-500 transition-colors";

                        if (!reportLoaded) loadPerformanceReport();
                    }
                }

                async function loadPerformanceReport() {
                    try {
                        const res = await fetch('/api/performance');
                        const data = await res.json();

                        const tbody = document.getElementById('perf-body');
                        tbody.innerHTML = '';

                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No data available.</td></tr>';
                            return;
                        }

                        // SIMULATION VARIABLES
                        const BET_SIZE = 100;
                        let totalInvested = 0;
                        let totalValue = 0;
                        let count = 0;

                        data.forEach((item, index) => {
                            count++;
                            totalInvested += BET_SIZE;

                            const m = parseFloat(item.multiplier);
                            // Value = Bet * Multiplier
                            const value = BET_SIZE * m;
                            totalValue += value;

                            const rank = index + 1;
                            let rankColor = 'text-gray-400';
                            if (rank === 1) rankColor = 'text-yellow-400 font-bold text-xl';
                            else if (rank === 2) rankColor = 'text-gray-300 font-bold text-lg';
                            else if (rank === 3) rankColor = 'text-orange-400 font-bold';

                            let multColor = 'text-gray-300';
                            if (m >= 10) multColor = 'text-purple-400 font-bold neon-text';
                            else if (m >= 5) multColor = 'text-green-400 font-bold';
                            else if (m >= 2) multColor = 'text-green-200';
                            else if (m < 0.5) multColor = 'text-red-400';

                            // Format Status
                            let statusBadge = '';
                            if (item.status === 'RUGGED') statusBadge = 'üíÄ RUG';
                            else if (item.status === 'MOONED') statusBadge = 'üöÄ MOON';

                            const row = `
                            <tr class="hover:bg-gray-750 transition-colors">
                                <td class="px-6 py-4 ${rankColor}">#${rank}</td>
                                <td class="px-6 py-4 font-bold text-white">
                                    ${item.symbol} 
                                    <span class="text-xs text-gray-500 font-normal ml-2">${new Date(item.date).toLocaleDateString()}</span>
                                    ${statusBadge ? `<span class="ml-2 text-xs bg-gray-700 px-1 rounded text-white">${statusBadge}</span>` : ''}
                                </td>
                                <td class="px-6 py-4 text-gray-400 font-mono">$${(item.entryMc / 1000).toFixed(1)}k</td>
                                <td class="px-6 py-4 text-white font-mono">$${(item.athMc / 1000).toFixed(1)}k</td>
                                <td class="px-6 py-4 font-mono ${value > 100 ? 'text-green-400' : 'text-red-400'}">$${value.toFixed(2)}</td>
                                <td class="px-6 py-4 ${multColor} text-lg">${item.multiplier}x</td>
                            </tr>
                        `;
                            tbody.innerHTML += row;
                        });

                        // Update Sim Cards
                        const pnl = totalValue - totalInvested;
                        document.getElementById('sim-count').innerText = count;
                        document.getElementById('sim-invested').innerText = `$${totalInvested.toLocaleString()}`;
                        document.getElementById('sim-value').innerText = `$${totalValue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

                        const pnlEl = document.getElementById('sim-pnl');
                        pnlEl.innerText = `${pnl >= 0 ? '+' : ''}$${pnl.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                        pnlEl.className = `text-3xl font-bold mt-1 ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;

                        // --- üß™ STRATEGY LAB CALCULATION ---
                        let stratPnl = 0;
                        let tp1Hits = 0;
                        let tp2Hits = 0;
                        let failures = 0;
                        let totalStratLoss = 0;

                        const STRAT_BET = 100;

                        data.forEach(item => {
                            const m = parseFloat(item.multiplier);

                            // Logic:
                            // < 1.5x: Loss (-$100)
                            // >= 1.5x: Sell 50% ($75). Remaining 50% risk free.
                            // >= 2.5x: Sell other 50% ($125). Total $200.
                            // If 1.5x <= m < 2.5x: Second half stops at Entry ($50). Total $125.

                            let outcome = 0;

                            if (m < 1.5) {
                                outcome = -STRAT_BET; // Loss
                                failures++;
                                totalStratLoss += STRAT_BET;
                            } else if (m >= 1.5 && m < 2.5) {
                                // Hit TP1, Missed TP2 (Stopped at BE)
                                // 50% sold at 1.5 ($75)
                                // 50% sold at 1.0 ($50)
                                // Total Return: $125. Profit: +$25
                                outcome = 25;
                                tp1Hits++;
                            } else if (m >= 2.5) {
                                // Hit TP1 & TP2
                                // 50% sold at 1.5 ($75)
                                // 50% sold at 2.5 ($125)
                                // Total Return: $200. Profit: +$100
                                outcome = 100;
                                tp1Hits++; // Also counts as TP1 hit
                                tp2Hits++;
                            }

                            stratPnl += outcome;
                        });

                        // Update Strategy UI
                        const stratPnlEl = document.getElementById('strat-pnl');
                        stratPnlEl.innerText = `${stratPnl >= 0 ? '+' : ''}$${stratPnl.toLocaleString()}`;
                        stratPnlEl.className = `text-3xl font-bold mt-1 ${stratPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;

                        const roi = (stratPnl / totalInvested) * 100;
                        document.getElementById('strat-roi').innerText = `ROI: ${roi.toFixed(1)}%`;

                        const tp1Rate = count > 0 ? (tp1Hits / count) * 100 : 0;
                        document.getElementById('strat-tp1').innerText = `${tp1Rate.toFixed(1)}%`;
                        document.getElementById('strat-tp1-count').innerText = `${tp1Hits}/${count} Tokens`;

                        const tp2Rate = count > 0 ? (tp2Hits / count) * 100 : 0;
                        document.getElementById('strat-tp2').innerText = `${tp2Rate.toFixed(1)}%`;
                        document.getElementById('strat-tp2-count').innerText = `${tp2Hits}/${count} Tokens`;

                        const failRate = count > 0 ? (failures / count) * 100 : 0;
                        document.getElementById('strat-rekt').innerText = `${failRate.toFixed(1)}%`;
                        document.getElementById('strat-loss-val').innerText = `-$${totalStratLoss.toLocaleString()}`;

                        reportLoaded = true;

                    } catch (err) {
                        console.error(err);
                        document.getElementById('perf-body').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading report.</td></tr>';
                    }
                }
            </script>
        </div>
</body>

</html>